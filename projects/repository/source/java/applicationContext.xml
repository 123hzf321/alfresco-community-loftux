<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<!-- This file must be split up once the number and spread of beans increases -->
<beans>
   
   <!--                    -->
   <!--  PERSISTENCE       -->
   <!--                    -->
   
   <!-- load common properties -->
   <bean id="db-properties" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
      <property name="location">
         <value>db.properties</value>
      </property>
   </bean>
   
   <!-- Datasource bean -->
   <bean id='dataSource' class='org.apache.commons.dbcp.BasicDataSource'
         destroy-method='close'>
      <property name='driverClassName'>
         <value>${db.driver}</value>
      </property>
      <property name='url'>
         <value>${db.url}</value>
      </property>
      <property name='username'>
         <value>${db.username}</value>
      </property>
      <property name='password'>
         <value>${db.password}</value>
      </property>
   </bean>
   
   <bean id='sessionFactory' class='org.springframework.orm.hibernate3.LocalSessionFactoryBean'>
      <property name='dataSource' >
         <ref local='dataSource' />
      </property>
      <property name='mappingResources' >
         <list>
            <value>com/activiti/repo/domain/hibernate/Node.hbm.xml</value>
            <value>com/activiti/repo/domain/hibernate/Workspace.hbm.xml</value>
         </list>
      </property>
      <property name='hibernateProperties' >
         <props>
            <prop key='hibernate.dialect' >org.hibernate.dialect.MySQLDialect</prop>
            <prop key='hibernate.show_sql'>false</prop>
            <prop key='hibernate.hbm2ddl.auto'>create</prop>
            <prop key='hibernate.cache.use_query_cache'>true</prop>
            <prop key='hibernate.max_fetch_depth'>1</prop>
            <prop key='hibernate.cache.provider_class'>org.hibernate.cache.EhCacheProvider</prop>
         </props>
      </property>
   </bean>
   
   <!-- create a transaction manager to handle the Hibernate sessions -->
   <bean id='transactionManager' class='org.springframework.orm.hibernate3.HibernateTransactionManager'>
      <property name='sessionFactory'>
         <ref local='sessionFactory'/>
      </property>
   </bean>

   <!--                    -->
   <!--  INTERNAL SERVICES -->
   <!--                    -->
   
   <bean id='typedWorkspaceService' class='org.springframework.transaction.interceptor.TransactionProxyFactoryBean'>
      <property name='proxyInterfaces'>
         <value>com.activiti.repo.workspace.TypedWorkspaceService</value>
      </property>
      <property name='transactionManager'>
         <ref bean="transactionManager"/>
      </property>
      <property name="target">
         <bean class="com.activiti.repo.workspace.hibernate.TypedWorkspaceServiceImpl" >
            <property name="sessionFactory">
               <ref bean="sessionFactory" />
            </property>
            <property name="typedNodeService">
               <ref bean="typedNodeService" />
            </property>
         </bean>
      </property>
      <property name="transactionAttributes">
         <props>
            <prop key="*">PROPAGATION_REQUIRED</prop>
         </props>
      </property>
   </bean>

   <bean id='typedNodeService' class='org.springframework.transaction.interceptor.TransactionProxyFactoryBean'>
      <property name='proxyInterfaces'>
         <value>com.activiti.repo.node.TypedNodeService</value>
      </property>
      <property name='transactionManager'>
         <ref bean="transactionManager"/>
      </property>
      <property name="target">
         <bean class="com.activiti.repo.node.hibernate.TypedNodeServiceImpl" >
            <property name="sessionFactory">
               <ref bean="sessionFactory" />
            </property>
         </bean>
      </property>
      <property name="transactionAttributes">
         <props>
            <prop key="*">PROPAGATION_REQUIRED</prop>
         </props>
      </property>
   </bean>

   <!--                    -->
   <!--  PUBLIC SERVICES   -->
   <!--                    -->
   
   <bean id="workspaceService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
      <property name="proxyInterfaces">
         <value>com.activiti.repo.workspace.WorkspaceService</value>
      </property>
      <property name="transactionManager">
         <ref bean="transactionManager"/>
      </property>
      <property name="target">
         <bean class="com.activiti.repo.workspace.WorkspaceServiceImpl" >
            <property name="typedWorkspaceService">
               <ref bean="typedWorkspaceService" />
            </property>
         </bean>
      </property>
      <property name="transactionAttributes">
         <props>
            <prop key="*">PROPAGATION_REQUIRED</prop>
         </props>
      </property>
   </bean>
   
   <bean id="nodeService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
      <property name="proxyInterfaces">
         <value>com.activiti.repo.node.NodeService</value>
      </property>
      <property name="transactionManager">
         <ref bean="transactionManager"/>
      </property>
      <property name="target">
         <bean class="com.activiti.repo.node.NodeServiceImpl" autowire="autodetect" />
      </property>
      <property name="transactionAttributes">
         <props>
            <prop key="*">PROPAGATION_REQUIRED</prop>
         </props>
      </property>
   </bean>

</beans>
